# Agent Instructions for meshery/schemas Repository

This document provides guidance for AI agents working on the meshery/schemas repository to avoid common mistakes and follow established patterns.

## Schema Modification Guidelines

### 1. DO NOT Commit Generated Code

**CRITICAL**: When modifying schema JSON files, only commit the schema files themselves. Do NOT commit:

- Go files in `models/` directory
- TypeScript files in `typescript/` directory  
- Generated OpenAPI YAML files (`merged-openapi.yml`, `cloud_openapi.yml`, `meshery_openapi.yml`)

These files are auto-generated by the build process and should not be manually committed.

### 2. Use Non-Deprecated References

**Use**: `../../v1alpha1/core/openapi.yml#/components/schemas/<schema_name>`
**Do NOT use**: `../../core.json#/definitions/<definition_name>` (deprecated)

The `core.json` file is deprecated. All references should use the OpenAPI YAML format from `v1alpha1/core/openapi.yml`.

### 3. Adhere to Naming Conventions

- Property names
  - Use camelCase for property fields (e.g., `schemaVersion`, `displayName`, `componentsCount`).
  - Identifier fields use lowerCamelCase with "Id" suffix (e.g., `modelId`, `registrantId`, `categoryId`).
  - Enums use lowercase words (e.g., `enabled`, `ignored`, `duplicate`).

- OpenAPI schema names
  - PascalCase nouns under `components/schemas` (e.g., `Model`, `Component`).
  - Files/folders are lowercase: `<construct>.yml`, `openapi.yml`, `<construct>_template.(json|yaml)`.

- Endpoints and operations
  - Paths are under `/api` with kebab-case , plural nouns (e.g., `/api/workspaces`, `/api/environments`).
  - Path params are camelCase  (e.g., `{subscriptionId}`, `{connectionId}`).
  - Non-CRUD actions append a verb segment (e.g., `.../register`, `.../export`, `.../cancel`); legacy lowerCamelCase may appear (e.g., `.../upgradePreview`).
  - `operationId` is camelCase VerbNoun (e.g., `registerMeshmodels`).

- Versioning
  - `schemaVersion` uses group/version (e.g., `models.meshery.io/v1beta1`, `components.meshery.io/v1beta1`).
  - Version strings follow k8s-style (`v1`, `v1alpha1`, `v1beta1`); semver fields use standard SemVer.

#### Common Schema References

- **Timestamps**: `../../v1alpha1/core/openapi.yml#/components/schemas/created_at`
- **Timestamps**: `../../v1alpha1/core/openapi.yml#/components/schemas/updated_at`
- **UUID**: `../../v1alpha1/core/openapi.yml#/components/schemas/uuid`
- **Version String**: `../../v1alpha1/core/openapi.yml#/components/schemas/versionString`
- **Semver String**: `../../v1alpha1/core/openapi.yml#/components/schemas/semverString`

### 4. Timestamp Field Pattern

When adding `created_at` and `updated_at` fields to schemas:

```json
{
  "created_at": {
    "$ref": "../../v1alpha1/core/openapi.yml#/components/schemas/created_at",
    "x-order": 14
  },
  "updated_at": {
    "$ref": "../../v1alpha1/core/openapi.yml#/components/schemas/updated_at",
    "x-order": 15
  }
}
```

**Do NOT include** additional `x-oapi-codegen-extra-tags` when using the reference - these are already defined in the core schema.

### 5. Template File Updates

When updating schema JSON files, also update the corresponding template files (e.g., `*_template.json`) with default values:

```json
{
  "created_at": "0001-01-01T00:00:00Z",
  "updated_at": "0001-01-01T00:00:00Z"
}
```

### 6. Path Adjustments for v1alpha3

For schemas in `v1alpha3` directory, adjust the path accordingly:

```json
{
  "created_at": {
    "$ref": "../v1alpha1/core/openapi.yml#/components/schemas/created_at"
  },
  "updated_at": {
    "$ref": "../v1alpha1/core/openapi.yml#/components/schemas/updated_at"
  }
}
```

## Build and Test Process

### Building Schemas

```bash
make setup          # Install dependencies
make build          # Build all schemas (generates Go, TypeScript, OpenAPI files)
```

### Testing

```bash
go test ./...       # Run Go tests
```

### What Gets Generated

The build process automatically generates:

1. **Go structs** from schema JSON files via `oapi-codegen`
2. **TypeScript definitions** from schema JSON files
3. **Merged OpenAPI YAML files** from individual schema components

## File Organization

```
schemas/
├── constructs/
│   ├── v1alpha1/
│   │   └── core/
│   │       └── openapi.yml          # Core schema definitions (use this!)
│   ├── v1alpha3/
│   │   ├── relationship.json        # Schema definitions
│   │   └── relationship_template.json
│   ├── v1beta1/
│   │   ├── model/
│   │   │   ├── model.json           # Schema definitions
│   │   │   └── model_template.json
│   │   └── component/
│   │       ├── component.json
│   │       └── component_template.json
│   └── core.json                     # DEPRECATED - do not use
├── models/                           # Auto-generated Go code (do NOT commit)
└── typescript/                       # Auto-generated TypeScript (do NOT commit)
```

## Common Mistakes to Avoid

1. ❌ Committing generated Go code in `models/` directory
2. ❌ Committing generated TypeScript code in `typescript/` directory
3. ❌ Using deprecated `core.json` references
4. ❌ Adding redundant `x-oapi-codegen-extra-tags` when using schema references
5. ❌ Forgetting to update template files with default values
6. ❌ Not testing the build process after schema changes

## Checklist for Schema Changes

- [ ] Modified only schema JSON files (not generated code)
- [ ] Updated corresponding template files with default values
- [ ] Used non-deprecated `v1alpha1/core/openapi.yml` references
- [ ] Removed redundant tags when using schema references
- [ ] Ran `make build` successfully
- [ ] Ran `go test ./...` successfully
- [ ] Verified only schema JSON files are in the commit

## Questions?

If you're unsure about any schema modification:

1. Check existing schemas for patterns (e.g., `environment.json`, `connection.json`)
2. Look at `v1alpha1/core/openapi.yml` for available schema definitions
3. Review this document for guidelines
4. Test your changes with `make build` before committing

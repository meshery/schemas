# Agent Instructions for meshery/schemas Repository

This document provides guidance for AI agents working on the meshery/schemas repository to avoid common mistakes and follow established patterns.

## Schema Modification Guidelines

### 1. DO NOT Commit Generated Code

**CRITICAL**: When modifying schema JSON files, only commit the schema files themselves. Do NOT commit:

- Go files in `models/` directory
- TypeScript files in `typescript/generated/` directory
- TypeScript files in `dist/` directory
- Generated OpenAPI YAML files (`merged-openapi.yml`, `cloud_openapi.yml`, `meshery_openapi.yml`)

These files are auto-generated by the build process and should not be manually committed.

### 2. Use Non-Deprecated References

**Use**: `../../v1alpha1/core/openapi.yml#/components/schemas/<schema_name>`
**Do NOT use**: `../../core.json#/definitions/<definition_name>` (deprecated)

The `core.json` file is deprecated. All references should use the OpenAPI YAML format from `v1alpha1/core/openapi.yml`.

### 3. Adhere to Naming Conventions

- Property names
  - Use camelCase for property fields (e.g., `schemaVersion`, `displayName`, `componentsCount`).
  - Identifier fields use lowerCamelCase with "Id" suffix (e.g., `modelId`, `registrantId`, `categoryId`).
  - Enums use lowercase words (e.g., `enabled`, `ignored`, `duplicate`).

- OpenAPI schema names
  - PascalCase nouns under `components/schemas` (e.g., `Model`, `Component`).
  - Files/folders are lowercase: `<construct>.yml`, `openapi.yml`, `templates/<construct>_template.(json|yaml)`.

- Endpoints and operations
  - Paths are under `/api` with kebab-case, plural nouns (e.g., `/api/workspaces`, `/api/environments`).
  - Path params are camelCase (e.g., `{subscriptionId}`, `{connectionId}`).
  - Non-CRUD actions append a verb segment (e.g., `.../register`, `.../export`, `.../cancel`); legacy lowerCamelCase may appear (e.g., `.../upgradePreview`).
  - `operationId` is camelCase VerbNoun (e.g., `registerMeshmodels`).

- Versioning
  - `schemaVersion` uses group/version (e.g., `models.meshery.io/v1beta1`, `components.meshery.io/v1beta1`).
  - Version strings follow k8s-style (`v1`, `v1alpha1`, `v1beta1`); semver fields use standard SemVer.

#### Common Schema References

- **Timestamps**: `../../v1alpha1/core/openapi.yml#/components/schemas/created_at`
- **Timestamps**: `../../v1alpha1/core/openapi.yml#/components/schemas/updated_at`
- **UUID**: `../../v1alpha1/core/openapi.yml#/components/schemas/uuid`
- **Version String**: `../../v1alpha1/core/openapi.yml#/components/schemas/versionString`
- **Semver String**: `../../v1alpha1/core/openapi.yml#/components/schemas/semverString`

### 4. Timestamp Field Pattern

When adding `created_at` and `updated_at` fields to schemas:

```json
{
  "created_at": {
    "$ref": "../../v1alpha1/core/openapi.yml#/components/schemas/created_at",
    "x-order": 14
  },
  "updated_at": {
    "$ref": "../../v1alpha1/core/openapi.yml#/components/schemas/updated_at",
    "x-order": 15
  }
}
```

**Do NOT include** additional `x-oapi-codegen-extra-tags` when using the reference - these are already defined in the core schema.

### 5. Template File Updates

Templates are manually defined files located in the `templates/` subdirectory within each schema folder. You can have multiple template files for different variants or use cases.

When updating schema JSON files, also update the corresponding template files in the `templates/` subdirectory (e.g., `templates/<construct>_template.json`) with default values:

```json
{
  "created_at": "0001-01-01T00:00:00Z",
  "updated_at": "0001-01-01T00:00:00Z"
}
```

You can add additional variant templates as needed (e.g., `<construct>_minimal_template.json`, `<construct>_full_template.yaml`).

### 6. Path Adjustments for v1alpha3

For schemas in `v1alpha3` directory, adjust the path accordingly:

```json
{
  "created_at": {
    "$ref": "../v1alpha1/core/openapi.yml#/components/schemas/created_at"
  },
  "updated_at": {
    "$ref": "../v1alpha1/core/openapi.yml#/components/schemas/updated_at"
  }
}
```

## Build and Test Process

### Building Schemas

```bash
make setup          # Install dependencies
make build          # Build all schemas (generates Go, TypeScript, OpenAPI files)
```

### Testing

```bash
go test ./...       # Run Go tests
```

### What Gets Generated

The build process automatically generates:

1. **Go structs** from schema JSON files via `oapi-codegen` → `models/<version>/<package>/`
2. **TypeScript type definitions** (`.d.ts` files) → `typescript/generated/<version>/<package>/`
3. **TypeScript schema exports** (`*Schema.ts` files) → `typescript/generated/<version>/<package>/`
4. **Merged OpenAPI YAML files** from individual schema components → `_openapi_build/`
5. **Built distribution files** → `dist/`

## File Organization

```
schemas/
├── constructs/
│   ├── v1alpha1/
│   │   └── core/
│   │       └── openapi.yml          # Core schema definitions (use this!)
│   ├── v1alpha3/
│   │   ├── relationship/
│   │   │   └── templates/
│   │   │       └── relationship_template.json
│   │   └── relationship.json        # Schema definitions
│   ├── v1beta1/
│   │   ├── model/
│   │   │   ├── model.json           # Schema definitions
│   │   │   ├── openapi.yml          # API operations
│   │   │   └── templates/           # Manually defined templates
│   │   │       ├── model_template.json
│   │   │       └── model_template.yaml
│   │   └── component/
│   │       ├── component.json
│   │       ├── openapi.yml
│   │       └── templates/
│   │           ├── component_template.json
│   │           └── component_template.yaml
│   └── core.json                     # DEPRECATED - do not use
├── models/                           # Auto-generated Go code (do NOT commit)
├── typescript/
│   ├── index.ts                      # Manually maintained - public API surface
│   ├── generated/                    # Auto-generated TypeScript (do NOT commit)
│   │   ├── v1alpha1/
│   │   │   ├── capability/
│   │   │   │   ├── Capability.d.ts   # Type definitions
│   │   │   │   └── CapabilitySchema.ts  # Schema as JS object
│   │   │   └── core/
│   │   ├── v1alpha2/
│   │   │   └── catalog/
│   │   └── v1beta1/
│   │       ├── component/
│   │       ├── model/
│   │       ├── pattern/              # Contains Design schema
│   │       ├── environment/
│   │       ├── workspace/
│   │       └── ...
│   └── rtk/                          # RTK Query client configs
└── dist/                             # Built output (do NOT commit)
    ├── index.js
    ├── index.d.ts
    ├── cloudApi.js
    ├── mesheryApi.js
    └── generated/                    # Built schema exports
        └── v1beta1/
            └── model/
                └── ModelSchema.js
```

## TypeScript Index File

The `typescript/index.ts` file is **manually maintained** and defines the public API surface:

- Import paths should use `./generated/<version>/<package>/<Name>` (without `.d.ts` extension)
- Schema imports use `./generated/<version>/<package>/<Name>Schema`
- Type references use the actual schema property names (often lowercase, e.g., `environment`, `workspace`)

### Current Import Pattern

```typescript
// Type imports (from .d.ts files, no extension needed)
import { components as ModelComponents } from "./generated/v1beta1/model/Model";

// Schema imports (from *Schema.ts files)
import ModelDefinitionV1Beta1OpenApiSchema from "./generated/v1beta1/model/ModelSchema";

// Type exports using indexed access
export namespace v1beta1 {
  export type Model = ModelComponents["schemas"]["ModelDefinition"];
  export type Environment = EnvironmentComponents["schemas"]["environment"];  // Note: lowercase
}
```

### Direct Schema Imports (for consumers)

When importing schemas directly from the built package, use the `constructs` path:

```typescript
// Direct schema imports use 'constructs' (not 'generated')
import ModelSchema from "@meshery/schemas/dist/constructs/v1beta1/model/ModelSchema";
import ComponentSchema from "@meshery/schemas/dist/constructs/v1beta1/component/ComponentSchema";
```

## Common Mistakes to Avoid

1. ❌ Committing generated Go code in `models/` directory
2. ❌ Committing generated TypeScript code in `typescript/generated/` directory
3. ❌ Committing built files in `dist/` directory
4. ❌ Using deprecated `core.json` references
5. ❌ Adding redundant `x-oapi-codegen-extra-tags` when using schema references
6. ❌ Forgetting to update template files in the `templates/` subdirectory with default values
7. ❌ Not testing the build process after schema changes
8. ❌ Placing template files outside the `templates/` subdirectory
9. ❌ Using `.d.ts` extension in TypeScript import paths
10. ❌ Assuming schema property names are PascalCase (check actual generated `.d.ts` files)

## Checklist for Schema Changes

- [ ] Modified only schema JSON/YAML files (not generated code)
- [ ] Updated corresponding template files in `templates/` subdirectory with default values
- [ ] Used non-deprecated `v1alpha1/core/openapi.yml` references
- [ ] Removed redundant tags when using schema references
- [ ] Ran `make build` successfully
- [ ] Ran `go test ./...` successfully
- [ ] Ran `npm run build` successfully
- [ ] Verified only schema JSON/YAML files are in the commit
- [ ] If updating `typescript/index.ts`, verified import paths are correct

## Questions?

If you're unsure about any schema modification:

1. Check existing schemas for patterns (e.g., `environment.json`, `connection.json`)
2. Look at `v1alpha1/core/openapi.yml` for available schema definitions
3. Check generated `.d.ts` files for actual type/property names
4. Review this document for guidelines
5. Test your changes with `make build` before committing
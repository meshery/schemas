---
name: contribute-to-schemas
description: 'Create and modify Meshery schemas. Covers directory structure, api.yml index files, naming conventions, code generation, Go helper files, TypeScript integration, and common patterns.'
---

# Contribute to Meshery Schemas

## Overview

This skill guides you through creating and modifying OpenAPI schemas in meshery/schemas, which generate Go structs, TypeScript types, and RTK Query clients consumed by Meshery Server, UI, and CLI.

## Prerequisites

### Required Tools

1. **Go (v1.24.0+)**
2. **oapi-codegen**: `go install github.com/oapi-codegen/oapi-codegen/v2/cmd/oapi-codegen@latest`
3. **Node.js & npm**
4. **make**

### Required Knowledge

1. Read the `meshery/schemas` README.md and AGENTS.md
2. Understand OpenAPI 3.0 specification basics
3. Schema files define the API contract

## Naming Conventions

### OpenAPI Schema Naming

| Element | Convention | Example |
|---------|------------|---------|
| Property names | camelCase | `schemaVersion`, `displayName`, `componentsCount` |
| Identifier fields | camelCase + "Id" suffix | `modelId`, `registrantId`, `categoryId` |
| Enums | lowercase | `enabled`, `ignored`, `duplicate` |
| Object names | singular nouns | `model`, `component`, `design` |
| Schema components | PascalCase | `Model`, `Component`, `Design` |
| Files/folders | lowercase | `api.yml`, `model.yaml` |

### Endpoint Naming

| Element | Convention | Example |
|---------|------------|---------|
| Paths | `/api` + kebab-case plurals | `/api/workspaces`, `/api/environments` |
| Path params | camelCase | `{subscriptionId}`, `{connectionId}` |
| operationId | camelCase VerbNoun | `getModels`, `createDesign`, `registerMeshmodels` |
| Non-CRUD actions | append verb segment | `.../register`, `.../export`, `.../cancel` |

## Workflow

### Task 1: Understand Directory Structure

Source schemas:
```text
schemas/constructs/
├── <version>/                    # v1alpha1, v1beta1
│   └── <construct>/              # model, component, design
│       ├── api.yml               # Index file (entry point)
│       ├── <construct>.yaml      # Main schema definition
│       ├── <construct>_core.yml  # Shared types (optional)
│       └── templates/
│           └── <construct>_template.json
```

Generated output (do NOT commit):
```text
schemas/
├── models/                       # Generated Go code
│   └── <version>/<package>/<package>.go
├── typescript/generated/         # Generated TypeScript
├── dist/                         # Built distribution
└── _openapi_build/               # Bundled OpenAPI specs
    ├── merged_openapi.yml
    ├── cloud_openapi.yml
    └── meshery_openapi.yml
```

### Task 2: Create or Modify api.yml

The `api.yml` file is the **index file** for each construct:
1. References all subschemas via `$ref`
2. Defines REST API endpoints
3. Entry point for code generators

```yaml
openapi: 3.0.0
info:
  title: Model API
  version: v1beta1

paths:
  /api/models:
    get:
      operationId: getModels
      tags:
        - Model
      responses:
        "200":
          description: Models returned
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Model"

components:
  schemas:
    Model:
      $ref: "./model.yaml#/Model"
```

### Task 3: Use Core References

Reference common types from `v1alpha1/core/api.yml`:

| Type | Reference |
|------|-----------|
| UUID | `../../v1alpha1/core/api.yml#/components/schemas/uuid` |
| created_at | `../../v1alpha1/core/api.yml#/components/schemas/created_at` |
| updated_at | `../../v1alpha1/core/api.yml#/components/schemas/updated_at` |
| versionString | `../../v1alpha1/core/api.yml#/components/schemas/versionString` |
| semverString | `../../v1alpha1/core/api.yml#/components/schemas/semverString` |

### Task 4: Cross-Construct References

Add `x-go-type` to avoid redundant Go structs:

```yaml
model:
  $ref: ../model/api.yml#/components/schemas/ModelReference
  x-go-type: model.ModelReference
  x-go-type-import:
    path: github.com/meshery/schemas/models/v1beta1/model
  description: Reference to the model
```

### Task 5: Preserve Field Order

Use `x-order` tag:

```yaml
properties:
  id:
    type: string
    x-order: 1
  name:
    type: string
    x-order: 2
  description:
    type: string
    x-order: 3
```

### Task 6: Create Go Helper Files

Helper files (`*_helper.go`) are manually created for:
- SQL Driver compatibility (Scan/Value methods)
- Entity interface implementation
- GORM TableName methods
- Utility methods

Location: `models/<version>/<package>/<package>_helper.go`

```go
// component_helper.go - This is NOT autogenerated
package component

import (
    "fmt"
    "database/sql/driver"
    
    "github.com/gofrs/uuid"
    "github.com/meshery/meshkit/database"
    "github.com/meshery/meshkit/models/meshmodel/entity"
    "github.com/meshery/schemas/models/core"
    "gorm.io/gorm/clause"
)

// TableName returns the database table name for GORM
func (c ComponentDefinition) TableName() string {
    return "component_definition_dbs"
}

// Type returns the entity type identifier
func (c ComponentDefinition) Type() entity.EntityType {
    return entity.ComponentDefinition
}

// GenerateID generates a new UUID for the entity
func (c *ComponentDefinition) GenerateID() (uuid.UUID, error) {
    return uuid.NewV4()
}

// GetID returns the entity's ID
func (c ComponentDefinition) GetID() uuid.UUID {
    return c.Id
}

// GetEntityDetail returns a human-readable description
func (c *ComponentDefinition) GetEntityDetail() string {
    return fmt.Sprintf("type: %s, name: %s, model: %s", 
        c.Type(), c.DisplayName, c.Model.Name)
}

// Create inserts the entity into the database
func (c *ComponentDefinition) Create(db *database.Handler, hostID uuid.UUID) (uuid.UUID, error) {
    c.Id, _ = c.GenerateID()
    err := db.Omit(clause.Associations).Create(&c).Error
    return c.Id, err
}

// Scan implements sql.Scanner interface for reading from database
func (c *ComponentDefinition) Scan(value interface{}) error {
    mapVal := core.Map{}
    err := mapVal.Scan(value)
    if err != nil {
        return err
    }
    return core.MapToStruct(mapVal, c)
}

// Value implements driver.Valuer interface for writing to database
func (c ComponentDefinition) Value() (driver.Value, error) {
    mapVal, err := core.StructToMap(c)
    if err != nil {
        return nil, err
    }
    return core.Map(mapVal).Value()
}
```

### Task 7: Update TypeScript Index

The `typescript/index.ts` is manually maintained:

```typescript
// Type imports (no .d.ts extension)
import { components as ModelComponents } from "./generated/v1beta1/model/Model";

// Schema imports
import ModelDefinitionV1Beta1OpenApiSchema from "./generated/v1beta1/model/ModelSchema";

// Export in namespace
export namespace v1beta1 {
  export type Model = ModelComponents["schemas"]["ModelDefinition"];
}

// Export schema
export { ModelDefinitionV1Beta1OpenApiSchema };
```

### Task 8: Build and Test

```bash
make build                    # Full build
npm run build                 # Build TS distribution
go test ./...                 # Run Go tests
npx @redocly/cli lint <path>  # Lint OpenAPI specs
```

## Common Patterns

### UUID Fields

```yaml
id:
  type: string
  format: uuid
  x-oapi-codegen-extra-tags:
    json: "id,omitempty"
    yaml: "id,omitempty"
    db: "id"
```

This generates Go struct tags:
```go
Id string `json:"id,omitempty" yaml:"id,omitempty" db:"id"`
```

### Nullable Time Fields

```yaml
deletedAt:
  type: string
  format: date-time
  nullable: true
  x-go-type: "sql.NullTime"
  x-go-import-path: "database/sql"
```

### Pagination Response

```yaml
<Construct>Page:
  type: object
  properties:
    page:
      type: integer
    data:
      type: array
      items:
        $ref: '#/components/schemas/<Construct>'
    totalCount:
      type: integer
    pageSize:
      type: integer
```

### String Arrays (pq.StringArray)

```yaml
roleNames:
  type: array
  items:
    type: string
  x-go-type: "pq.StringArray"
  x-go-import-path: "github.com/lib/pq"
```

### x-internal Annotation

Control which bundled output includes a path:

```yaml
paths:
  /api/entitlement/plans:
    get:
      x-internal: ["cloud"]  # Only included in cloud_openapi.yml
      operationId: getPlans
```

- **With `x-internal`**: Included only in the specified clients
- **Without `x-internal`**: Included in **all** clients

## Core Utility Types

The `models/core/` package provides reusable types with built-in SQL compatibility:

| Type | Purpose | Use Case |
|------|---------|----------|
| `core.Map` | `map[string]any` with SQL support | Storing JSON objects in database |
| `core.NullTime` | Nullable time with JSON/YAML support | Optional timestamp fields (e.g., `deleted_at`) |
| `core.Time` | Time wrapper with custom formatting | Required timestamp fields |

## Exemplar: Model Construct

The **Model** construct is the reference implementation for schema patterns.

### Reference Files

| File | Location | Purpose |
|------|----------|---------|
| `api.yml` | `schemas/constructs/v1beta1/model/api.yml` | Complete OpenAPI schema with paths and components |
| `model.yaml` | `schemas/constructs/v1beta1/model/model.yaml` | Main schema definition |
| `model_helper.go` | `models/v1beta1/model/model_helper.go` | Custom driver methods (NOT auto-generated) |

### Key Patterns from Model

1. Cross-schema references using `$ref` with external files
2. Custom Go type mappings with `x-go-type` and `x-go-type-import`
3. Nullable fields using `core.NullTime`
4. SQL Scanner/Valuer implementations in helper files
5. Entity interface implementation

## What to Commit

### DO Commit

- `constructs/<version>/<package>/api.yml`
- `constructs/<version>/<package>/*.yaml`
- `constructs/<version>/<package>/templates/`
- `typescript/index.ts`
- `models/<version>/<package>/*_helper.go`
- `models/core/datatype_*.go`

### Do NOT Commit

- `models/<version>/<package>/<package>.go` (auto-generated)
- `typescript/generated/`
- `dist/`
- `_openapi_build/`

## Schema File Roles

| File | Purpose |
|------|---------|
| `api.yml` | Index file - aggregates subschemas via `$ref` and defines API endpoints |
| `<construct>.yaml` | Subschema - main data model definition |
| `<construct>_core.yml` | Subschema - core/shared types |
| `templates/*.json` | Templates - example instances with default values |

## Validation Commands

```bash
# Lint OpenAPI schema
npx @redocly/cli lint schemas/constructs/v1beta1/<construct>/api.yml

# Full build (validates + generates)
make build

# Test generated Go code
go test ./models/v1beta1/<construct>/...
```

## Tips

1. **Study `v1beta1/model/`** - Use as reference for new schemas
2. **Match naming conventions exactly** - JSON tags must align with existing patterns
3. **Use `x-oapi-codegen-extra-tags`** - Preserves db and yaml tags in generated Go
4. **Add `x-go-type`** - Required when referencing other constructs to avoid duplicate structs
5. **Always rebuild after schema changes** - Generated code must match schema; stale code causes runtime errors
6. **Add `// This is not autogenerated.`** - First line of every helper file
7. **Use sync.Mutex in `Create()`** - Prevents race conditions during database inserts
